---
title: Comparing 7T Protocols for Imaging Basal Ganglia Activity During a Visual Orienting Task
authors:
  - name: Kelly G. Garner
    thanks: Corresponding author
    department: School of Psychology
    affiliation: University of Birmingham
    location: Edgbaston, UK, B13 2TT
    email: getkellygarner@gmail.com
  - name: Christopher R. Nolan
    department: School of Psychology
    affiliation: University of New South Wales
    location: Sydney, Australia
    email: cnolan@cn.id.au
  - name: Ole Jensen
    department: School of Psychology
    affiliation: University of Birmingham
    location: Edgbaston, UK, B13 2TT
    email: o.jensen@bham.ac.uk
  - name: Markus Barth
    department: Centre for Advanced Imaging
    affiliation: University of Queensland
    location: St. Lucia, Australia, 4072
    email: m.barth@uq.edu.au   
  - name: Saskia Bollmann
    department: Centre for Advanced Imaging
    affiliation: University of Queensland
    location: St. Lucia, Australia, 4072
    email: saskia.bollmann@cai.uq.edu.au
  - name: Marta Garrido
    department: School of Psychological Sciences
    affiliation: University of Melbourne
    location: Parkville, Australia, 3010
    email: marta.garrido@unimelb.edu.au
abstract: |
  Enter the text of your abstract here.
keywords:
  - blah
  - blee
  - bloo
  - these are optional and can be removed
bibliography: refs.bib
biblio-style: unsrt
output: 
  bookdown::pdf_book:
    base_format: rticles::arxiv_article
    keep_tex: true
  bookdown::word_document2:
    toc: true
---

```{r knitr_options, echo=FALSE}
library(knitr)
# rstudio will set the folder where .Rmd file seats as work directory
# set it back to the folder where .Rproj seats
#opts_knit$set(root.dir = normalizePath("../")) 
opts_chunk$set(fig.align = 'center', cache = FALSE, warning = FALSE,
  message = TRUE, echo = FALSE)
options(digits = 3, width = 88, knitr.graphics.auto_pdf = TRUE,
        knitr.kable.NA = '')
knit_hooks$set(inline = function(x) {
  x <- sprintf("%1.2f", x)
  paste(x, collapse = ", ")
})
# add this bit to differentiate p from stat values before sending around
# https://stackoverflow.com/questions/48199137/set-number-of-decimal-places-to-show-in-output
```

```{r, libraries, echo=FALSE, message=F, warning=F}
library(magrittr)
library(tidyverse)
library(cowplot)
library(readr)
library(wesanderson)
library(RJSONIO)
library(cowplot)
library(rlang)
library(kableExtra)
library(scales)
library(rstatix)
library(lme4) 
library(emmeans)
source("../R/R_rainclouds.R") # for the raincloud plot
source("../R/data_wrangles.R")
```

# Introduction

\label{sec:Introduction}

Characterizing the neurophysiology that underpins the ability to filter and extract goal-relevant information from the visual world has been a priority in neuroscience for multiple decades [e.g. @desimoneNeuralMechanismsSelective1995; @buschmanBehaviorNeuralDynamics2015a]. At the cortical level, visual information processing has been relatively well mapped out; many observations have demonstrated the correspondence of neural activity in frontal, parietal and visual cortices to the biasing of the visual system towards features that have been deemed as goal-relevant, i.e. visual selection [@buschmanBehaviorNeuralDynamics2015a; @corbettaControlGoaldirectedStimulusdriven2002]. However, the putative contribution of less interrogated subcortical structures such as the basal ganglia has only more recently become evident. For example, electrophysiological recordings from macaques indicate that cells in the caudate nucleus (CN) respond to the joint location and identity of objects [@yamamotoWhatWhereInformation2012], and contribute to the circuitry that guides both eye-movements [@amitaOptogeneticManipulationValuecoding2020a] and covert attention shifts [@arcizetCovertSpatialSelection2018] towards goal-relevant objects. Furthering theory for how the brain performs visual selection therefore requires an understanding of how basal ganglia and cortical structures interact to produce behaviour. Attaining this understanding in the human model is not a simple task, given the relative inaccessibility of basal ganglia activity to non-invasive imaging approaches. 

One potentially fruitful avenue is the utilisation of high-resolution functional magnetic resonance imaging (fMRI). Imaging the functional activity of the basal ganglia is challenging for multiple reasons. First, the relatively higher iron content of the nuclei of the basal ganglia [@drayerMagneticResonanceImaging1986] results in shorter $T^{*}_{2}$ relaxation times (~15 ms) compared to the cortex (~25-35 ms, @keukenUltraHigh7TMRI2013; @petersT2MeasurementsHuman2007; @vanderzwaagFMRICharacterisingBOLD2009; @yacoubImagingBrainFunction2001). For optimal BOLD-sensitivity, the echo time (TE) of a single echo-planar imaging (EPI) protocol should be equal to the $T^{*}_{2}$ of the tissue of interest [Posse, 1999]. Therefore, striking a balance in TE values to capture signal at both subcortex and cortex is not without challenge. [Have a chat with Markus about this section]. 
Introduce multi-echo, CMRR and 3D EPI].

This challenge has been well addressed in previous works that have sought to image functional basal ganglia activity during performance of overt actions at 7T. For example, Puckett et al [-@puckettUsingMultiechoSimultaneous2018] compared outcomes for SE and ME SMS EPI protocols when participants performed an overt action task that involved simple and complex sequences of self-paced button presses. The theoretical contribution of the basal ganglia to overt action is well documented [see Caligiore et al, 2017, Gurney et al, 2004 for reviews], and therefore imposing a cognitive challenge during overt action selection is the ideal starting point for determining the potential of 7T ME imaging for attaining good signal quality from the basal ganglia. The authors found that signal-to-noise ratios (SNR) were improved for the ME relative to the SE protocol, notably in CN and the putamen (Put). Furthermore, the extent of the improvement was negatively related to the underlying $T^{*}_{2}$ of the voxels. Therefore, signal from the tissues with shorter $T^{*}_{2}$, such as the basal ganglia, showed the greatest signal improvements with the ME protocol. This suggests that ME sequences may be of particularly benefit when imaging basal ganglia activity. In contrast, Militec et al [-@mileticFMRIProtocolOptimization2020] compared ME and SE protocols during performance of a stop-signal task where participants execute or withhold an overt motor response depending on a given auditory signal. The authors sought to optimise protocol parameters in order to attain whole brain coverage, while maintaining the spatial and temporal resolution required to capture signal from subcortical regions. Specifically, they held spatial resolution constant at 1.6 mm isotropic, and increased parallel acceleration to attain an ME sequence that was comparable in all other respects to the SE sequence. The authors found only marginal differences between SE and ME protocols, suggesting that the advantages of a ME sequence may be limited when testing more subtle manipulations of overt action control. It remains unknown whether ME protocols provide benefits when imaging basal ganglia activity during theoretically relevant cognitive operations that do not involve overt action, such as when visual selection is biased during a covert visual selection task.

We therefore sought to compare SNR for basal ganglia activity between protocols used to take whole brain images while participants performed a covert visual-selection task. The task required participants to monitor two spatial locations for an upcoming target (oriented gabor). The target and a distractor stimulus were preceded by probabilistic spatial cues that indicated the likely location of the upcoming target, as well as incentive value cues that signalled reward availability on any given trial. We compared the signal yielded between ME and SE multi-band and 3D EPI protocols at 7T. To assess signal quality we compared both temporal signal-to-noise (tSNR) and contrast-noise (CNR) ratios. tSNR, computed as the ratio of the mean of the timeseries relative to the standard deviation of the timeseries ($\frac{mu_{T}}{\sigma_{T}}$) provides a measure of the strength of the activation signal of the time course, relative to several sources of noise such as system, physiological and task-related. The measure of activation (i.e. signal) contains both baseline signal and task-related fluctuations. Thus the measure of tSNR quantifies how the global signal level is related to the noise [@welvaertDefinitionSignalToNoiseRatio2013]. To assess the strength of signal changes in relation to key experimental events, we computed $t$-scores from key contrasts of interest that are defined below. This is equivalent to computing the temporal SNR for the mean signal change [@corbinAccurateModelingTemporal2018]. Thus we sought to understand how our chosen protocols influenced these two complementary measures of signal strength in key regions of interest.

Thus we aimed to assess which protocol (ME, CMRR, 3D EPI) yielded the strongest signal in the basal ganglia during a visual-orienting task. As T2* signal is stronger for cortical tissue, we compared SNR values in each of the basal ganglia nuclei (see Figure \@ref(fig:aims)) to that observed for key cortical nodes. As the involvement of the human basal ganglia in visual selection behaviours is largely theoretical, we also compared SNR when modeling activity in response to experimental manipulations known to modulate visual selection (e.g. laterality of target location, probability/certainty offered by a spatial cue), to those that have been empirically demonstrated to influence human basal-ganglia activity (i.e. overt actions). Lastly, as our key cortical nodes were identified using a meta-analysis of largely 3T data (see methods section below), and because differences in functional localisation have been observed between 3T and 7T for other cognitive tasks [@torrisiStatisticalPowerComparisons2018], we also measured SNR in the most responsive voxels across the brain, for comparison to that observed in the _a priori_ defined regions of interest.

```{r aims, out.width = "50%", fig.cap="Regions of interest. A) Basal Ganglia anterior view, B) Basal Ganglia posterior view, C) Cortical ROIs. CN = Caudate Nucleus, GPe = Globus Pallidus External, GPi = Globus Pallidus Internal, Put = Putamen, STN = Subthalamic Nucleus, VS = Ventral Striatum, FEF = Frontal Eye Fields, IPS = Intraparietal Sulcus, LOC = Lateral Occipital Complex. Note the Nucleus Accumbens (NAcc) was also included but is not pictured here."}
paradigm.fig.pth <- '../images/Fig_ROIs.png'
#paradigm.fig <- readPNG(paradigm.fig.pth, native=TRUE, info=TRUE)
include_graphics(paradigm.fig.pth)
```

# Methods
\label{sec:Methods}

## Participants
\label{sec:Participants}

A total of 5 participants [1 female, 1 left-handed, mean age: 30.6 yrs, std: 7.7] took part in the experiment. Participants had normal or corrected-to-normal vision, and all reported no major neurological or psychiatric diagnoses, or use of psychoactive medications. All participants received 20 AUD per hour for participation. Participants also earned cash rewards, contingent on the accuracy and speed of responses in the presence of incentive value cues (~15 AUD per session). The University of Queensland Human Research Ethics Committee approved the study as being within the guidelines of the National Statement on Ethical Conduct in Human Research and all participants gave informed, written consent.

## Experimental Protocols
\label{sec:Protocols}

Participants attended four experimental sessions; an initial behavioural session, where participants learned the the task procedures, and three sessions in the MRI scanner. A full description of the initial behavioural session can be found online [here](). 
  
### Paradigm
\label{sec:BehavParadigm}

We adapted a previously published visual selection task where participants made orientation judgements to a visual target, while ignoring a distractor. The target and distractor were prececed by probabilistic spatial and incentive value cues [@garnerIncentiveValueSpatial2021] (see Figure \@ref{fig:paradigm}). Note that while we used a combination of value and spatial cues, as we intend to use both in future work, we currently focus on only the influence of spatial cues for the following reasons; the influence of spatial cues on visual selection has been shown to be a robust and highly replicable behavioural effect documented over multiple decades [@posnerOrientingAttention1980; @carrascoVisualAttention252011; @chicaSpatialOrientingParadigm2014], particularly in relation to corresponding cortical activity [@corbettaControlGoaldirectedStimulusdriven2002; @desimoneNeuralMechanismsSelective1995; @fiebelkornDynamicInterplayFrontoparietal2018]. Moreover, the effect of spatial cues have recently been the subject of scrutiny with regard to the contribution of basal ganglia/cortical interactions [@wangInvolvementStriatalDirect2020; @arcizetCovertSpatialSelection2018; @hermanAttentionrelatedModulationCaudate2020]. The influence of incentive cues on visual orienting have on the other hand, only been investigated relatively more recently [@raymondSelectiveVisualAttention2009; @chelazziRewardsTeachVisual2013; @failingSelectionHistoryHow2018], and the mapping of the cortical correlates of incentive cueing is still being established [e.g. @andersonRewardProcessingValuedriven2017; @stanisorUnifiedSelectionSignal2013]. 

### Experimental Task Apparatus
\label{sec:Apparatus}

Experimental procedures were run using a [blah blah PC]. Visual displays were projected with a [blah blah] projector, to a [blah blah] screen with a FOV of 358 x 230 mm, a resolution of 1600 x 1200 pixels, and a refresh rate of 60 Hz. Distance from the coil mirror to the projector screen was 1300 mm, and the distance of the participant to the coil mirror was approximately 50 mm. The experimental procedures were implemented using custom written software for Matlab 2018b and Psychtoolbox v3.0.15 [@brainardPsychophysicsToolbox1997; @pelliVideoToolboxSoftwareVisual1997]. 


### Stimuli
\label{sec:Stimuli}

All stimuli were presented on a grey [RGB: 128, 128, 128] background. A grey cross [RGB: 115, 115, 115] superimposed over a diamond (rotated white square [RGB: 191, 191, 191, 45$^\circ$]) was presented in the centre of the screen and served as a fixation point. The grey cross subtended 0.8$^\circ$ visual angle, and the diamond subtended 1.6$^\circ$. A leftward or rightward facing triangle [RGB: 90, 90, 90], superimposed on one half of the white diamond served as the informative spatial cue (p=.8). Simultaneous presentation of both triangles served as an uninformative spatial cue (p=.5). The two triangles together comprised 80 % of the surface area of the underlying white square. Two coloured discs (!x! $^\circ$ in diameter, matched for luminance; [gold RGB: 182, 133, 58, rose RGB: 230, 93, 85]) served as value cues. These were presented 5.5$^\circ$ from the centre along, and 2$^\circ$ below  the horizontal meridian. Further information on the value configurations are presented in the procedure section below. Target and distractor stimuli were presented within the value cue discs. Targets were a gabor (3$^\circ$ in diameter, standard deviation of the Gaussian envelope, 0.3; spatial frequency, 2.5/ppd (pixels per degree)) oriented 45$^\circ$ clockwise or counter-clockwise. Distractors shared the same visual features except they were presented on one of the cardinal axes. The distance of the target and distractor from the centre was chosen so that the viewer could discriminate the gabors without making an eye-movement, while remaining just within the locus of high-acuity vision (~6$^\circ$). The target and distractors were followed by mask stimuli, which consituted a patch of pixels randomly weighted between the background grey and white, weighted by the same Gaussian envelope as was used for the target and distractor. Feedback reward values were presented centrally in alphanumeric characters, and were presented in yellow in the case of correct responses (i.e. in the case of reward gain, [RGB: 255, 215, 0]), and in grey [RGB: 90, 90, 90] for errors. 

### Behavioural Procedure
\label{sec:BehavProcs}

As shown in Figure \@ref(fig:paradigm), each trial began with the the central fixation display (cross and diamond). The duration of this display varied across the protocols as we adjusted visual display onsets to coincide with the TR pulses sent from the MRI scanner ($a_t$; ME: 1100 ms, CMRR: 2020 ms, 3D-EPI: 2840 ms). The duration of the key visual events was held constant across all three protocols. Nexr, the fixation cross was removed and the value cues onset. After 400 ms, the spatial cue was presented for 300 ms. The target and distractor were presented after a random interval between 0-100 ms after spatial cue offset (selected from a uniform distribution). The target and distractor were displayed for 67 ms, and were followed by the masks which were displayed for 67 ms. The orientation of the target (45$^\circ$ clockwise or counterclockwise) and the distractor (vertical or horizontal) was fully counterbalanced across target-distractor pairing, location, and cueing condition. The value cues and central white diamond remained on display during the response interval [$b_t$; ME: 1826-1926 ms, CMRR: 2136-2146 ms, 3D EPI: 946 - 1046 ms]. Next, reward feedback was presented contingent on the participant's response. The duration of the feedback display was 1000 ms for both correct and incorrect responses. For correct responses, the maximum reward value available was weighted ($w$) by the proportion of the participant's response time (RT) of a given range (350 ($RT_{min}$) - 850 ($RT_{max}$) ms) - i.e. $w= \frac{RT_t - RT_{min}}{RT_{max} - RT_{min}}$. For the reward feedback display, the previous reward total was displayed on the left followed by a plus sign and the reward value attained on that trial to the right. Over the next second, the new reward value counted down as the previous reward value increased, over 50 ms intervals. In the case of an incorrect response, the previous points total was displayed in dark grey in the centre of the screen. 

The incentive value cues were included in the current paradigm as this task formed the basis for a larger, ongoing study that seeks to map the human brain networks whose functional activity corresponds to both cue types, which will be reported elsewhere. 
Participants monitored two locations for an upcoming oriented gabor, which was preceded by cues that indicated the likely location or the incentive value of the upcoming gabor. 

**Spatial cue probabilities** 
Directional spatial cues (see Figure \@ref(fig:paradigm), panel C) carried a p = ~.8 (.78) chance of validly signalling the upcoming target location. Bidirectional cues signalled either location with p = .5. Across each functional run, there were 72 trials containing a directional cue (56 valid, 16 invalid), and 56 trials containing a bidirectional cue. Laterality of target location was fully counterbalanced over all cue conditions. Note that when modelling the fMRI data focus on comparisons between the valid (p=.8) and bidirectional (p=.5) conditions. We don't make comparisons between these and the invalid trials, given the latter's lower trial numbers and consequent higher likelihood of variance differences to the other conditions. The reward available was matched across the spatial cueing trials, so that neither spatial cue condition (p=.2, .5, .8) nor location (left vs right) predicted a greater reward value than another. 

**Value cue configurations** 
Each value cue colour signalled the probability of attaining a high value reward, relative to attaining a low value reward, should the target appear at that location (see Figure \@ref(fig:paradigm), Panel B). For example, for a given participant, the gold colour would predict a high reward value with p = .8, and therefore signalled a higher expected reward value ($H$). In contrast, the rose colour would predict a high reward value with p = .2, and would therefore signal a lower expected reward value ($L$). Value cues were presented in 4 different possible combinations, which where fully counterbalanced over location (left vs right), and from now are coded in relation to the location where the upcoming target and distractor appeared; 1) both the target and distractor locations could contain the high expected reward value colour ($H_{tgt}/H_{dst}$), 2) both locations could contain the low expected reward value colour ($L_{tgt}/L_{dst}$), 3) the target location could contain the high expected reward value colour, whereas the distractor location contained the low expected value colour ($H_{tgt}/L_{dst}$), or 4) vice-versa ($L_{tgt}/H_{dst}$). Participants learned the colour-reward associations in the previous behavioural session, specific colour-reward mappings were counterbalanced over participants. 

Participants had received extensive instructions and training in the aforementioned task during the initial behavioural session, the details of which can be found [here](). In addition to these instructions, participants were requested to remain as still as possible during the functional runs.

```{r paradigm, out.width = "70%", fig.cap="Cueing paradigm. A) Trial sequence, B) value- and C) spatial-cue contingencies, D) Behaviour: Inverse efficiency (RT/accuracy) given the probability of the target location, shown for each each protocol. Error bars reflect SEM. T=target, D=distractor, CW=clockwise, CCW=counterclockwise, ME=multi-echo, CMRR=, 3D=3D Echo Planar Imaging"}
paradigm.fig.pth <- '../images/ParadigmBehav.png' 
include_graphics(paradigm.fig.pth)
```

## Scanning Procedures
\label{sec:ScanProcs}

Each participant was scanned over three sessions, on a 7T MRI system (Siemens Healthineers, Germany) using a 32-channel phased array headcoil (Nova Medical, Wilmington, US). Within each session, participants completed 3 functional runs, 1 for each protocol (see Table \@ref(tab:acquistable) for protocol details). For each participant, all three sessions took place at the same time of day. Each session started with a short localizer scan, the anatomical scan, and then the 3 functional runs. The order of the protocols used for each functiona run was randomised across sessions. The functional runs varied slightly in duration, owing to the differences in the inter-trial-interval, which was dependent on the TR of each protocol (ME = 10:52 mins, CMRR = 13:02, 3D EPI = 12:44).

Participant #1 completed only the first two sessions, due to scheduling error. For participant #3, the 3D EPI was stopped early in the third scanning session, rendering it impossible to reconstruct the images. All remaining data was included in the analysis.

### MR Protocols
\label{sec:MRProts}

The details for each of the functional protocols are defined in Table 1. Each was chosen to yield high resolution while maintaining the field of view (FOV) required to assess BOLD activity changes in both the subcortical and cortical ROIs.

The MP2RAGE was acquired with the following parameters: TR = 4300 ms, TE = 3.38 ms, 0.8 mm isotropic, T1 1 = 840 ms, T1 2 = 2370 ms, flip angle 1 = 5$^\circ$, flip angle 2 = 6$^\circ$, FOV = 240 mm x 225 mm x 192 mm. 

```{r acquistable, echo=FALSE, message=F, warning=F}

# Show it:
TRs <- data.frame(TR=c(700, 1510, 1920), 
                  TE=c('10, 30.56','19.4','22'),
                  VoxSizeIso = c(2, 1.5, 1.5),
                  PhaseEncodingDirGRAPPA = c('2','3','2'),
                  MultiBandFactor=c('4','3','CAiPI shift 1'),
                  ExcitFlipAngle=c(35,60,15),
                  ReceiverBand_Hz_Px=c(1930,1116,1116),
                  partFourier=c('5/8','6/8','6/8'),
                  FOV=c('192 x 192 x 96','192 x 192 x 122','192 x 192 x 120'),
                  Nslices=c(48,81,80))
rownames(TRs) <- c("ME", "CMRR", "3DEPI")
kable(t(TRs), caption="Compared Protocols") %>% kable_classic(full_width=F, html_font="Cambria")

```

### Preprocessing
\label{sec:Preproc}

All anatomical and functional data were preprocessed using _fMRIprep_ (version 1.5.8; [estebanFMRIPrepRobustPreprocessing2019]), which is based on _Nipype 1.4.1_ [@gorgolewskiNipypeFlexibleLightweight2011; @estebanNipyNipype2020]. 

**Anatomical data preprocessing** 
Each T1-weighted (T1w) image was corrected for intensity non-uniformity (INU) with `N4BiasFieldCorrection` [@tustisonN4ITKImprovedN32010], distributed with ANTs 2.2.0 [@avantsSymmetricDiffeomorphicImage2008, RRID:SCR_004757]. The T1w-reference was then skull-stripped with a *Nipype* implementation of the `antsBrainExtraction.sh` workflow (from ANTs), using OASIS30ANTs as target template. Brain tissue segmentation of cerebrospinal fluid (CSF), white-matter (WM) and gray-matter (GM) was performed on the brain-extracted T1w using `fast` [FSL 5.0.9, RRID:SCR_002823, @zhangSegmentationBrainMR2001]. A T1w-reference map was computed after registration of 3 T1w images (after INU-correction) using `mri_robust_template` [FreeSurfer 6.0.1, @reuterHighlyAccurateInverse2010]. Brain surfaces were reconstructed using `recon-all` [FreeSurfer 6.0.1, RRID:SCR_001847, @daleCorticalSurfaceBasedAnalysis1999], and the brain mask estimated previously was refined with a custom variation of the method to reconcile ANTs-derived and FreeSurfer-derived segmentations of the cortical gray-matter of Mindboggle [RRID:SCR_002438, @kleinMindbogglingMorphometryHuman2017]. Volume-based spatial normalization to one standard space (MNI152NLin2009cAsym) was performed through nonlinear registration with `antsRegistration` (ANTs 2.2.0), using brain-extracted versions of both T1w reference and the T1w template. The following template was selected for spatial normalization: *ICBM 152 Nonlinear Asymmetrical template version 2009c* [@fonovUnbiasedNonlinearAverage2009, RRID:SCR_008796; TemplateFlow ID: MNI152NLin2009cAsym].

**Regions of Interest**
Of pertinent interest to the current work was the sensitivity of the three protocols to activation in the basal ganglia and in cortical nodes that have been consistently related to visual selection behaviours. Thus, ROIs were selected based on human basal ganglia anatomy, and for cortical regions of interest; on a meta-analysis of previous findings.

_Nuclei of the Basal Ganglia_: The ROIs from the basal ganglia were the caudate nucleus (CN), the ventral striatum (VS), putamen (Put), globus pallidus external (GPe), globus pallidus internal (GPi), and the sub-thalamic nucleus (STN). These were identifed using a published atlas derived from high-resolution 7T anatomical imaging [@keukenProbabilisticAtlasBasal2015], including the manual division of the striatum into the CN, Put, and VS reported in [@puckettUsingMultiechoSimultaneous2018]. As the goal of the analysis was to ascertain the sensitivity of each protocol to the contrasts of interest in each ROI, rather than seeking to assess any directional relationships between spatial attention and laterality of functional response, the left and right images of each ROI were joined to form a bilateral mask image. 
  
_Cortical ROIs_: The cortical regions of interest were identified using the Neurosynth meta-analytic association test from  [topic 303](https://neurosynth.org/analyses/topics/v4-topics-400/303), of the set [v4-topics-400](https://neurosynth.org/analyses/topics/v4-topics-400/), which contains the top-loading topic terms: attention, orienting, spatial, attentional, cued, target, cue, cueing and endogenous cues. This meta-analysis identified 5 ROIs including the left and right frontal eye fields (FEF), left and right intra-parietal sulcus (IPS), and the left lateral occipital complex (LOC). The approximate centre of each ROI was defined in MNI co-ordinates, and a sphere with a radius of 5 mm was defined around the co-ordinates using `fslmaths`. The resulting images were binarised and served as the cortical masks.

Each mask was transformed from MNI space to participant space using the ANTs `ApplyTransforms` wrapper, using the reverse of the transforms provided by fMRIprep [*from-MNI152NLin2009cAsym_to_t1w_mode-image_xfm.h5*]. Each mask file in subject space was then resliced (using SPM's `Reslice` wrapper) to match the dimensions of the functional images from each T2* protocol. 

**Functional data processing**
For each BOLD run, the following preprocessing was performed. First, a reference volume and its skull-stripped version were generated using a custom methodology of *fMRIPrep*. A deformation field to correct for susceptibility distortions was estimated based on *fMRIPrep*'s *fieldmap-less* approach. The deformation field is that resulting from co-registering the BOLD reference to the same-subject T1w-reference with its intensity inverted [@wangComparisonImageIntensity2017; @huntenburgLaminarPythonTools2017]. Registration is performed with `antsRegistration` (ANTs 2.2.0), and the process regularized by constraining deformation to be nonzero only along the phase-encoding direction, and modulated with an average fieldmap template [@treiberCharacterizationCorrectionGeometric2016]. Based on the estimated susceptibility distortion, a corrected EPI (echo-planar imaging) reference was calculated for a more accurate co-registration with the anatomical reference. The BOLD reference was then co-registered to the T1w reference using `bbregister` (FreeSurfer) which implements boundary-based registration [@greveAccurateRobustBrain2009]. Co-registration was configured with six degrees of freedom. Head-motion parameters with respect to the BOLD reference (transformation matrices, and six corresponding rotation and translation parameters) are estimated before any spatiotemporal filtering using `mcflirt` [FSL 5.0.9, @jenkinsonImprovedOptimizationRobust2002]. BOLD runs were slice-time corrected using `3dTshift` from AFNI 20160207 [@coxSoftwareToolsAnalysis1997, RRID:SCR_005927]. The BOLD time-series, were resampled to surfaces on the following spaces: *fsaverage*, *fsnative*. The BOLD time-series (including slice-timing correction) were resampled onto their original, native space by applying a single, composite transform to correct for head-motion and susceptibility distortions. These resampled BOLD time-series will be referred to as *preprocessed BOLD in original space*, or just *preprocessed BOLD*. The BOLD time-series were resampled into standard space, generating a *preprocessed BOLD run in 'MNI152NLin2009cAsym' space*. First, a reference volume and its skull-stripped version were generated using a custom methodology of *fMRIPrep*. Several confounding time-series were calculated based on the *preprocessed BOLD*: framewise displacement (FD), DVARS and three region-wise global signals. FD and DVARS are calculated for each functional run, both using their implementations in *Nipype* [following the definitions by @power_fd_dvars]. The three global signals are extracted within the CSF, the WM, and the whole-brain masks. 

Further pre-processing and analyses performed subsequent to running *fMRIprep* was completed using a computing environment defined by [a singularity container for which the recipe is available online](https://github.com/kel-github/code-4-seq-comp-test-7T/blob/master/Singularity). All remaining procedures were implemented using Nipype (version 1.6.0), ANTs 2.2.0, and SPM12-r7219, using a combination of [Python Jupyter notebooks and custom Matlab code that are available online](https://github.com/kel-github/code-4-seq-comp-test-7T). 

**Multi-echo combination** Next, the multi-echo images were combined within each session, using a weighted summation as defined in Puckett et al, [-@puckettUsingMultiechoSimultaneous2018]. Specifically, weights were calculated per voxel, $w_n$, using the formula:

$w_n = \frac{AVG_n \cdot TE_n}{\sum AVG_n \cdot TE_n}$

where $AVG$ is the temporal average of the time-series. This weighting scheme carries the advantage that the weights can be directly estimated from the data, and no additional calibration scans or model assumptions are required. Moreover, this method has been shown to work as equally well as other combination schemes [@kettingerInvestigatingGroupLevelImpact2016]. 

### Single subject analysis
\label{sec:SingSub}

As we were concerned with the contrast-to-noise ratios observed within _a priori_ defined anatomical ROIs, we opted to conduct the analysis in subject space, rather than normalised space. This was motivated by the requirement for anatomical accuracy. Thus all the subsequent analyses were performed on the pre-processed BOLD (as defined above). We sought to examine protocol quality on two indices of interest; the tSNR ($\frac{\mu}{\sigma}$) and CNR for contrasts of theoretical interest.

#### tSNR 
\label{sec:tSNRMeth}

We computed tSNR for each functional run, by computing for each voxel the ratio between the mean and the standard deviation of the time series. The resulting tSNR images were then averaged over session for each subject, and the average tSNR was taken from each ROI, using `spm_read_vols` (to get the x, y, z coordinates for each ROI) and `spm_get_data` to extract the tSNR values from the voxels of interest. 

#### CNR
\label{sec:CNRMeth}

We sought to acertain the sensitivity of the three protocols to the experimental events of interest. We therefore computed for each voxel the $t$-score for activation strength relative to baseline, for a given condition mean. This is directly related to the computation for tSNR measures that quantify the amplitude of activation (relative to baseline), relative to the noise [@corbinAccurateModelingTemporal2018]. The resulting $t$-scores thus provide a measure of the sensitivity of each protocol to the key experimental events. To attain $t$-scores for the events of interest, T2* data were first temporally filtered using a highpass filter (cut-off 1/128 Hz) to remove slow drifts. Spatial smoothing was then applied, using a Gaussian kernel of 2 mm FWHM, as this was found to stabilise the $t$-score estimates. 

We next fit two GLMs to each participant's data; one that would allow computation of $t$-scores for conditions of overt action, and one for computation of $t$-scores for the attentional manipulations of interest. We opted to fit the two GLMs separately to the data as this allowed us to model the data with relatively simple GLMs, and response-hand was fully counterbalanced over the attentional manipulations. To model the effect of response hand, a GLM with two regressors were defined, one for left hand responses and one for right hand responses. To model the effect of the attentional manipulations, a second GLM was fit that contained 4 regressors, reflecting the 2 x 2 design of target laterality (left vs right) x spatial cue probability (p= .5 vs .8). GLMs were fit using the canonical double-gamma haemodynamic response function (HRF) [@fristonAnalysisFunctionalMRI1994, @fristonEventRelatedFMRICharacterizing1998, @fristonStatisticalParametricMaps1994, @gloverDeconvolutionImpulseResponse1999] with time and dispersion derivatives, and using the FAST option for pre-whitening [@corbinAccurateModelingTemporal2018]. GLM model specification and estimation were conducted using the `SpecifySPMModel`, `Level1Design` and `EstimateModel` wrapper functions from Nipype. 

We sought to determine the sensitivity of the three protocols to the following condition means of interest; first, we chose to model activation for the response hand, relative to baseline, as overt action contrasts are typically used to assess SNR in the basal ganglia [@puckettUsingMultiechoSimultaneous2018; mileticFMRIProtocolOptimization2020], and this therefore provides a good basis for comparison to the results attained when modelling the attentional manipulations of interest. Next we modelled laterality of the target, relative to baseline, as previous evidence suggests that cells in the striatum respond to combined object location and identity [@yamamotoWhatWhereInformation2012]. Next we computed the activation contrast for each spatial cue condition (p=.5 vs .8), as the basal ganglia has been hypothesised to encode the probability of sensory inputs in visual decision making [@caballeroProbabilisticDistributedRecursive2018]. Last we computed activation contrasts for target laterality, for the p=.8 spatial cue condition. We computed this contrast as we sought to ascertain sensitivity to the lateralised excitation and inhibition that has been hypothesised to occur when spatial targets enable prioritisation of locations for upcoming target processing [@schmitzNormalizationCholinergicMicrocircuit2018; @reynoldsNormalizationModelAttention2009], and further, these latter two cells of the design contain the lowest number of trials that may be used to generate a mean value in a subsequent experiment. Therefore these last contrasts show the weakest or worst case SNR scenario for an experimental event of interest, where a psychological effect of interest is evident. Thus a total of eight $t$-contrasts (against zero) were applied. We now refer to the $t$-score measure as the contrast-noise-ratio (CNR). 

Last, we investigated whether any of the protocols offered a SNR ratio when making comparisons between experimental conditions of interest. To this end, we computed F-contrasts for the main effect of response hand (left - right), the main effect of target laterality (left - right), the main effect of spatial cue probability (p=.8 - p=.5), and the target laterality x cue probability interaction. Given the relationship between $t$ and F, we take the resulting F values as a measure of CNR.

We investgated the CNR data from each contrast in two ways. To ascertain the influence of protocol on CNR in regions where there was high probability of event-related activation changes, we thresholded each contrast at p < .001 and computed summary statistics on the remaining voxels. Next, we extracted CNR values for each contrast from each ROI and computed the mean of the top 30 % of voxels, after removing outliers (values > than the 97.5th quantile). Given the strong existing evidence suggesting that any of the experimental manipulations should influence a functionally localised subset of voxels within a given striatal region [@liuFunctionalParcellationHuman2021; @choiOrganizationHumanStriatum2012; @ogawaStriatalSubdivisionsThat2018; @haberCorticostriatalCircuitry2016a], that some of the anatomical ROIs contain thousands of voxels, and that signal levels of the striatal regions are typically low, we reasoned that the impact of averaging across all voxels in a given region may serve to wash out genuinely observable differences between protocols when the response is functionally localised. Therefore, we instead sought to understand how protocol modulated CNR across the voxels most responsive to the experimental events of interest within each ROI. 

#### Assessment of recovered HRF functions
\label{sec:AssessHRF}

To assess visually whether the current protocols yielded a typical HRF in subcortical ROIs, a GLM was fit to each participant's data using a Finite Impulse Response (FIR) function (length: 18 seconds, order: 9). If a typical HRF function is present, then the parameters of the FIR should recover the HRF shape. To avoid potential overfitting to noise owing to the increase of number of parameters in the FIR function, a simplified design matrix was defined, which contained regressors for target laterality only. As above, this was achieved using the `SpecifySPMModel` and `Level1Design` Nipype wrappers. Prior to model estimation, and owing to the presence of overlapping trials within a condition (due to the fast event-related design of the protocols), the regressors were de-orthogonalised (within condition) using a custom adaptation of the [`spm_fMRI_design`](https://github.com/kel-github/code-4-seq-comp-test-7T/blob/master/spm_fMRI_design_copy.m) function. The resulting GLMs were estimated as above. 
  
#### Statistical Approach
\label{sec:StatsApproach}

Statistical analyses were conducted using R (version 3.3.2, [@Rcitation]) and RStudio (version 1.1.456, [@rstudiocitation]). Protocol comparison methods were based on those presented in Puckett et al [-@puckettUsingMultiechoSimultaneous2018] and Miletic et al [-@mileticFMRIProtocolOptimization2020]. We extracted average tSNR scores per subject, protocol and ROI and applied linear mixed effects models with average tSNR as the dependent variable, using the lme4 package [@batesFittingLinearMixedEffects2015]. For the CNR data, ROI (where relevant), protocol, and contrast (where relevant) served as predictor variables, including all possible interaction terms. Random intercepts were included for each subject. Statistical significance of the predictor variables was assessed using Type II Wald chisquare tests, using the car package [@foxCompanionAppliedRegression2019], followed up with post-hoc Tukey contrasts, with application of the Sidak adjustment for multiple comparisons [@sidakRectangularConfidenceRegions1967]. Where relevant, effect sizes are reported using Cohen's $d$. 

# Results
\label{sec:Results}

## Behaviour
\label{sec:Behaviour}

Given the N of 5 participants, we present the influence of cue certainty on participant's behaviour for visual inspection (see Figure \@ref(fig:paradigm), panel D), rather than applying inferential statistics, owing to the low statistical power for group-level inference in response time data. However, analysis of the individual participant data from the initial behavioural session demonstrated a statistically significant influence of both cue types (spatial and value) on each participant's response times (RTs). A description of this data is available [here](). 

Outliers from correct response times (RTs) were defined as those less than 200 ms, or greater than 2.5 times the standard deviation above the mean for each participant, protocol and cueing condition, and were removed from the data. As both RT and accuracy are influenced by the certainty offered by spatial cues, an inverse efficiency score was computed for each participant, protocol and cueing condition by taking $\frac{RT_{mu}}{Acc}$. Given the widespread replication of the influence of spatial cues on visual selection [@chicaSpatialOrientingParadigm2014], including a very similar previously published paradigm [@garnerIncentiveValueSpatial2021], we interpret our data as reflecting a cost to visual selection at unlikely target locations (p=.2).

## Comparison of tSNR between protocols
\label{sec:tSNRResults}

First we sought to determine which protocol yielded the highest tSNR values across the _a priori_ defined ROIs. The tSNR data were extracted for each subject, protocol and ROI, the results of which are presented in Figure \@ref{fig:tSNR}. As can be seen from panel A, strongest tSNR was observed for the ME protocol, then for the 3D EPI, and last for the CMRR protocol. 

```{r loadtSNR, echo=FALSE, message=F, warning=F}

# Load and tidy data HAND GLM DATA

tSNR = read.csv('../data/tSNR_ROI_agg.csv')
tSNR $sub <- factor(tSNR$sub)
tSNR$TR <- factor(tSNR$TR)
tSNR$roi <- factor(tSNR$roi)
names(tSNR)[names(tSNR) == "contrast"] = "session"
tSNR$session <- factor(tSNR$session)
names(tSNR)[names(tSNR) == "tT"] = "tSNR"

tSNR$TR <- tSNR$TR %>% recode('700' = 'ME',
                              '1510' = 'CMRR',
                              '1920' = '3D')
tSNR <- tSNR %>% mutate(roi=factor(roi, levels = c('FEF', 'IPS', 'LOC', 'VS', 'CN', 'Put', 'GPe', 'GPi', 'STN')))

mutSNR <-tSNR %>% group_by(sub, TR, roi) %>%
                           summarise(tSNR = mean(tSNR)) %>%
                           ungroup()

```

```{r, tSNRanalysis, echo=FALSE, message=F, warning=F}

tsnr_mod <- lmer( tSNR ~ TR*roi+ (1|sub), data=mutSNR)
tst_tsnr_mod <- Anova(tsnr_mod, test.statistic="F")
# test cortical
cort_tsnr <- mutSNR %>% filter(roi == "FEF" | roi == "IPS" | roi == "LOC")
cort_tsnr_mod <- lmer(tSNR ~ TR*roi+ (1|sub), data = cort_tsnr)
tst_cort_tsnr_mod <- Anova(cort_tsnr_mod, test.statistic = "F")
# cortical follow up
cort_tsnr_me <- emmeans(cort_tsnr_mod, "TR")
cntrst_cort_tsnr_me <- contrast(cort_tsnr_me, 'tukey', adjust = 'sidak') 
cntrst_cort_tsnr_me <- cntrst_cort_tsnr_me %>% broom::tidy()
cntrst_cort_tsnr_me <- cntrst_cort_tsnr_me %>% filter(adj.p.value<.05)

# now testing subcortical
sc_tsnr <- mutSNR %>% filter(roi != "FEF" & roi != "IPS" & roi != "LOC")
sc_tsnr_mod <- lmer(tSNR ~ TR*roi+ (1|sub), data = sc_tsnr)
tst_sc_tsnr_mod <- Anova(sc_tsnr_mod, test.statistic = "F")
# subcortical follow up
sc_tsnr_int <- emmeans(sc_tsnr_mod, pairwise ~ TR|roi, adjust = 'sidak')
cntrst_sc_tsnr_int <- contrast(sc_tsnr_int, adjust = 'sidak') 
```

The tSNR scores indeed differed by protocol, and this difference was modulated by the ROIs, as was evidenced by a significant TR x ROI interaction (F(`r tst_tsnr_mod["TR:roi", "Df"]`, `r tst_tsnr_mod["TR:roi", "Df.res"]`) = `r tst_tsnr_mod["TR:roi", "F"]`, p = `r tst_tsnr_mod["TR:roi", "Pr(>F)"]`). To further investigate this interaction, and given the known signal differences between cortical and subcortical regions, the same analysis was applied separately to the cortical and the subcortical ROIs. Figure \@ref{fig:tSNR}, panel B shows the signal advantage for a representative cortical ROI (IPS) relative to representative subcortical ROIs (CNR and Put). For the cortical ROIs, tSNR was consistentlu modulated by protocol across the IPS, FEF and LOC. This was evidenced by a main effect of protocol (F(`r tst_cort_tsnr_mod["TR", "Df"]`, `r tst_cort_tsnr_mod["TR", "Df.res"]`) = `r tst_cort_tsnr_mod["TR", "F"]`, p = `r tst_cort_tsnr_mod["TR", "Pr(>F)"]`), whereas neither the main effect of ROI nor the protocol x ROI interaction achieved statistical significance (both ps > `r tst_cort_tsnr_mod["roi", "Pr(>F)"]`). With regard to the main effect of protocol, the ME protocol showed increased tSNR relative to the CMRR (t(`r cntrst_cort_tsnr_me[cntrst_cort_tsnr_me$contrast == "ME - CMRR","df"]`) = `r cntrst_cort_tsnr_me[cntrst_cort_tsnr_me$contrast == "ME - CMRR","statistic"]`, $d$ = `r cntrst_cort_tsnr_me[cntrst_cort_tsnr_me$contrast == "ME - CMRR","estimate"]/(cntrst_cort_tsnr_me[cntrst_cort_tsnr_me$contrast == "ME - CMRR","std.error"]*sqrt(cntrst_cort_tsnr_me[cntrst_cort_tsnr_me$contrast == "ME - CMRR","df"]+1))`, p = `r cntrst_cort_tsnr_me[cntrst_cort_tsnr_me$contrast == "ME - CMRR","adj.p.value"]`), and the 3D-EPI showed higher tSNR relative to the CMRR protocol (t(`r cntrst_cort_tsnr_me[cntrst_cort_tsnr_me$contrast == "CMRR - 3D","df"]`) = `r abs(cntrst_cort_tsnr_me[cntrst_cort_tsnr_me$contrast == "CMRR - 3D","statistic"])`, $d$ = `r abs(cntrst_cort_tsnr_me[cntrst_cort_tsnr_me$contrast == "CMRR - 3D","estimate"]/(cntrst_cort_tsnr_me[cntrst_cort_tsnr_me$contrast == "CMRR - 3D","std.error"]*sqrt(cntrst_cort_tsnr_me[cntrst_cort_tsnr_me$contrast == "CMRR - 3D","df"]+1)))`, p = `r cntrst_cort_tsnr_me[cntrst_cort_tsnr_me$contrast == "CMRR - 3D","adj.p.value"]`). In contrast, the effect of protocol was modulated across subcortical ROIs, as was evidenced by a significant protocol x ROI interaction (F(`r tst_sc_tsnr_mod["TR:roi", "Df"]`, `r tst_sc_tsnr_mod["TR:roi", "Df.res"]`) = `r tst_sc_tsnr_mod["TR:roi", "F"]`, p = `r tst_sc_tsnr_mod["TR:roi", "Pr(>F)"]`). For each subcortical ROI, tSNR scores differed between each protocol with ME > 3D EPI > CMRR (all ps < .0001), apart from in the VS, where the difference between the ME and CMRR protocol did not reach statistical significance (p = .334). Overall, the ME protocol fared better in terms of tSNR across all ROIs, apart from in the VS, where it was not distinguishable from the 3D-EPI protocol.

```{r tSNR, out.width="70%", fig.cap="tSNR observed for the 3 protocols. A) tSNR across the whole brain for each protocol, for one example subject and session. B) Mean tSNR values from 3 key ROIs, across protocols (x-axis). Each line reflects data from one subject. ME = multi-echo, CMRR =, 3D = 3D Echo Planar Imaging, IPS = intra-parietal sulcus, CN = caudate nucleus, Put = putamen"}

tSNR_fig_pth <- '../images/tSNR_wholebrain_byReg.png' 
include_graphics(tSNR_fig_pth)
```

### Comparing CNR Between Protocols
\label{sec:CNRResults}

#### Thresholded voxels
\label{sec:Thrshvox}

Next we sought to determine which protocol yielded the highest CNR values, at the voxels that showed the strongest activation to the experimental events of interest. To attain responsive voxels, each contrast image was thresholded at p<.001. First we examined the CNR values for each response hand (left or right > 0), by applying a LME model to the response hand $t$-scores, with contrast (left or right hand), protocol and their interaction modeled as fixed effects, and with an intercept term for each subject.

```{r loadCNRdatT, echo=FALSE, message=F, warning=F}

# Load and tidy data HAND GLM DATA
tconts_thrsh = read.csv('../data/HANDS_activationC_tCNR_stat_vox_agg.csv')
tconts_thrsh$sub <- factor(tconts_thrsh$sub)
tconts_thrsh$TR <- factor(tconts_thrsh$TR)
tconts_thrsh$roi <- factor(tconts_thrsh$roi)
tconts_thrsh$contrast <- factor(tconts_thrsh$contrast)
names(tconts_thrsh)[names(tconts_thrsh) == "tT"] = "CNR"
tconts_thrsh$contrast <- tconts_thrsh$contrast %>%  recode('2' = 'left_hand',
                                                           '3' = 'right_hand') 

tmp = read.csv('../data/TC_activationC_tCNR_stat_vox_agg.csv')
tmp$sub <- factor(tmp$sub)
tmp$TR <- factor(tmp$TR)
tmp$roi <- factor(tmp$roi)
tmp$contrast <- factor(tmp$contrast)
names(tmp)[names(tmp) == "tT"] = "CNR"

tmp$contrast <- tmp$contrast %>% recode('4' = 'lft tgt',
                                        '5' = 'rght tgt',
                                        '6' = 'p8',
                                        '7' = 'p5',
                                        '8' = 'lft_p8',
                                        '9' = 'rght_p9')

tconts_thrsh <- rbind(tconts_thrsh, tmp)

tconts_thrsh$TR <- tconts_thrsh$TR %>% recode('700' = 'ME',
                                              '1510' = 'CMRR',
                                              '1920' = '3D EPI')
names(tconts_thrsh)[names(tconts_thrsh) == "contrast"] <- "comp"
mutConts <- tconts_thrsh %>% group_by(sub, TR, comp) %>%
                            summarise(mu = mean(CNR)) %>% ungroup()
rm(tmp)
```

```{r thrshlook, echo=FALSE, message=F, warning=F}
# bpkpsubs <- with(mutConts %>% filter(comp == "left_hand" | comp == "right_hand"), boxplot(mu~comp*TR))
#bpkpsubs
```


```{r thrshLME_handT, echo=FALSE, message=F, warning=F}
thrshmod_handT <- lmer( mu ~ TR*comp + (1|sub), data = mutConts %>% filter(comp == "left_hand" | comp == "right_hand"))
thrshmod_handT_an <- Anova(thrshmod_handT, test.statistic="F")
```


```{r, thrsh_me_prot_FU, echo=FALSE, message=F, warning=F}
thrsh_handT_me_prot <- emmeans(thrshmod_handT, "TR")
thrsh_handT_me_cont <- contrast(thrsh_handT_me_prot, 'tukey', adjust = 'sidak') 
thrsh_handT_me_cont <- thrsh_handT_me_cont %>% broom::tidy()
thrsh_handT_me_prot <-thrsh_handT_me_prot %>% broom::tidy()
#thrsh_handT_me_cont
```  

The thresholded CNR data from the response hand contrasts are presented in see Figure \@ref{fig:thrshCNR}, panels A & B. A significant main effect showed that CNR differed between protocols (F(`r thrshmod_handT_an["TR", "Df"]`, `r thrshmod_handT_an["TR", "Df.res"]`) = `r thrshmod_handT_an["TR", "F"]`, `r thrshmod_handT_an["TR", "Pr(>F)"]`. Post-hoc contrasts showed that CNR values were statistically higher for the ME protocol (mean = `r thrsh_handT_me_prot %>% filter(TR == "ME") %>% select("estimate")`, sd = `r thrsh_handT_me_prot %>% filter(TR == "ME") %>% select("std.error")*sqrt(thrsh_handT_me_prot %>% filter(TR == "ME") %>% select("df"))`) relative to the CMRR protocol (mean = `r thrsh_handT_me_prot %>% filter(TR == "CMRR") %>% select("estimate")`, sd = `r thrsh_handT_me_prot %>% filter(TR == "CMRR") %>% select("std.error")*sqrt(thrsh_handT_me_prot %>% filter(TR == "CMRR") %>% select("df"))`, t(`r thrsh_handT_me_cont %>% filter(contrast == "ME - CMRR") %>% select(df)`) = `r thrsh_handT_me_cont %>% filter(contrast == "ME - CMRR") %>% select(statistic)`, $d$ = `r thrsh_handT_me_cont %>% filter(contrast == "ME - CMRR") %>% select(estimate) / (thrsh_handT_me_cont %>% filter(contrast == "ME - CMRR") %>% select(std.error)*sqrt(thrsh_handT_me_cont %>% filter(contrast == "ME - CMRR") %>% select(df)))`, p = `r thrsh_handT_me_cont %>% filter(contrast == "ME - CMRR") %>% select(adj.p.value)`), and relative to the 3D EPI protocol (mean = `r thrsh_handT_me_prot %>% filter(TR == "3D EPI") %>% select("estimate")`, sd = `r thrsh_handT_me_prot %>% filter(TR == "3D EPI") %>% select("std.error")*sqrt(thrsh_handT_me_prot %>% filter(TR == "3D EPI") %>% select("df"))`, t(`r thrsh_handT_me_cont %>% filter(contrast == "ME - 3D EPI") %>% select(df)`) = `r thrsh_handT_me_cont %>% filter(contrast == "ME - 3D EPI") %>% select(statistic)`, $d$ = `r thrsh_handT_me_cont %>% filter(contrast == "ME - 3D EPI") %>% select(estimate) / (thrsh_handT_me_cont %>% filter(contrast == "ME - 3D EPI") %>% select(std.error)*sqrt(thrsh_handT_me_cont %>% filter(contrast == "ME - 3D EPI") %>% select(df)))`, p = `r thrsh_handT_me_cont %>% filter(contrast == "ME - 3D EPI") %>% select(adj.p.value)`). Moreover, and in contrast to the tSNR values, CNR for the CMRR protocol was statistically higher than for the 3D EPI protocol ( t(`r thrsh_handT_me_cont %>% filter(contrast == "CMRR - 3D EPI") %>% select(df)`) = `r thrsh_handT_me_cont %>% filter(contrast == "CMRR - 3D EPI") %>% select(statistic)`, $d$ = `r thrsh_handT_me_cont %>% filter(contrast == "CMRR - 3D EPI") %>% select(estimate) / (thrsh_handT_me_cont %>% filter(contrast == "CMRR - 3D EPI") %>% select(std.error)*sqrt(thrsh_handT_me_cont %>% filter(contrast == "CMRR - 3D EPI") %>% select(df)))`, p = `r thrsh_handT_me_cont %>% filter(contrast == "CMRR - 3D EPI") %>% select(adj.p.value)`). Neither the main effect of contrast nor the protocol x contrast interaction achieved statistical significance (both ps > `r min(thrshmod_handT_an[thrshmod_handT_an[,"Pr(>F)"] > .05, "Pr(>F)"])`). The thresholded CNR data therefore corroborate the tSNR findings that the ME protocol yields the best signal. However, in contrast to the tSNR findings, the data also show that when CNR instead of tSNR is considered, then the CMRR protocol also fares better than the 3D EPI protocol, but does not fare as well as the ME protocol. Therefore although the 3D EPI may show higher levels of baseline activation, this protocol may be less sensitive to experimentally relevant signal changes.

```{r actStatsCNR, out.width="70%", fig.cap="CNR from voxels thresholded at p< .001 for each contrast. A) CNR values from the left response hand activation contrast for one representative subject and session. B) Densities of CNR scores for both the left and right hand response for each protocol. C) Showing the left target laterality contrast for the same subject and session as panel A. D) Beta estimates (y-axis) across time (x-axis) as estimated by a FIR model. The model recovered a typical HRF function. ME = multi-echo, CMRR =, 3D = 3D Echo Planar Imaging, CNR = contrast noise ratio, t = time."}

thrsh_CNR_fig_pth <- '../images/ActStatsT_hands_CNR.pdf' 
include_graphics(thrsh_CNR_fig_pth)
```

```{r thrshLME_TCT, echo=FALSE, message=F, warning=F}
thrshmod_TCT <- lmer( mu ~ TR*comp + (1|sub), data = mutConts %>% filter(comp == "lft tgt" | comp == "rght tgt"))
thrshmod_TCT_an <- Anova(thrshmod_TCT, test.statistic="F")
thrsh_TCT_me_prot <- emmeans(thrshmod_TCT, "TR")
thrsh_TCT_me_cont <- contrast(thrsh_TCT_me_prot, 'tukey', adjust = 'sidak') 
thrsh_TCT_me_cont <- thrsh_TCT_me_cont %>% broom::tidy()
thrsh_TCT_me_prot <-thrsh_TCT_me_prot %>% broom::tidy()
```

```{r thrshLME_pspatialT, echo=FALSE, message=F, warning=F}
thrshmod_pspatial_T <- lmer( mu ~ TR*comp + (1|sub), data = mutConts %>% filter(comp == "p8" | comp == "p5"))
thrshmod_pspatial_an <- Anova(thrshmod_pspatial_T, test.statistic="F")
thrsh_pT_me_prot <- emmeans(thrshmod_pspatial_T, "TR")
thrsh_pT_me_cont <- contrast(thrsh_pT_me_prot, 'tukey', adjust = 'sidak') 
thrsh_pT_me_cont <- thrsh_pT_me_cont %>% broom::tidy()
thrsh_pT_me_prot <-thrsh_pT_me_prot %>% broom::tidy()
```

```{r thrshLME_latpspatialT, echo=FALSE, message=F, warning=F}
thrshmod_lat_pspatial_T <- lmer( mu ~ TR*comp + (1|sub), data = mutConts %>% filter(comp == "lft_p8" | comp == "rght_p9"))
thrshmod_lat_pspatial_an <- Anova(thrshmod_lat_pspatial_T, test.statistic="F")
thrsh_lpT_me_prot <- emmeans(thrshmod_lat_pspatial_T, "TR")
thrsh_lpT_me_cont <- contrast(thrsh_lpT_me_prot, 'tukey', adjust = 'sidak') 
thrsh_lpT_me_cont <- thrsh_lpT_me_cont %>% broom::tidy()
thrsh_lpT_me_prot <-thrsh_lpT_me_prot %>% broom::tidy()
```

```{r, concatCNRps, echo=FALSE, message=F, warning=F}
thrsh_CNR_ps <- c(thrshmod_TCT_an[,"Pr(>F)"], thrshmod_pspatial_an[,"Pr(>F)"], thrshmod_lat_pspatial_an[,"Pr(>F)"]) 
thrsh_CNR_ps <- thrsh_CNR_ps[thrsh_CNR_ps > .05]
fu_thrsh_CNR_ps <- as.vector(do.call(cbind, c(thrsh_lpT_me_cont[,"adj.p.value"], thrsh_pT_me_cont[,"adj.p.value"], thrsh_TCT_me_cont[,"adj.p.value"])))
```


```{r fx_szs_thrshCog, echo=FALSE, message=F, warning=F}

fx_szs_thrCog <- c(thrsh_lpT_me_cont$estimate / (thrsh_lpT_me_cont$std.error *  sqrt(thrsh_lpT_me_cont$df)), 
  thrsh_pT_me_cont$estimate / (thrsh_pT_me_cont$std.error * sqrt(thrsh_pT_me_cont$df)),
  thrsh_TCT_me_cont$estimate / (thrsh_TCT_me_cont$std.error * sqrt(thrsh_TCT_me_cont$df)))

```

We next sought to determine whether this pattern of protocol advantage held when modeling the more subtle aspects of the study, such as the laterality of target presentation or the level of certainty offered by the spatial cue. The main effect and pattern of protocol differences was broadly consistent across the remaining analyses, with the exception that both the ME and CMRR protocol outperformed the 3D EPI protocol, and not each other. Specifically, there was a main effect of protocol on the CNR data regardless of whether CNR values were computed using the target laterality (left or right) contrasts (F(`r thrshmod_TCT_an["TR", "Df"]`, `r thrshmod_TCT_an["TR", "Df.res"]`) = `r thrshmod_TCT_an["TR", "F"]`, p = `r thrshmod_TCT_an["TR", "Pr(>F)"]`), the spatial cue probability contrasts (p=.8 or p=.5, F(`r thrshmod_pspatial_an["TR", "Df"]`, `r thrshmod_pspatial_an["TR", "Df.res"]`) = `r thrshmod_pspatial_an["TR", "F"]`, p = `r thrshmod_pspatial_an["TR", "Pr(>F)"]`) or the target laterality|p = .8 contrasts (F(`r thrshmod_lat_pspatial_an["TR", "Df"]`, `r thrshmod_lat_pspatial_an["TR", "Df.res"]`) = `r thrshmod_lat_pspatial_an["TR", "F"]`, p = `r thrshmod_lat_pspatial_an["TR", "Pr(>F)"]`). In all cases, both the ME and CMRR protocols scored higher than the 3D-EPI protocol (all ps < `r max(fu_thrsh_CNR_ps[fu_thrsh_CNR_ps < .05])`), but not each other (all ps > `r min(fu_thrsh_CNR_ps[fu_thrsh_CNR_ps > .05])`). Interestingly, the size of the advantage was consistently large across all comparisons, with effect sizes ($d$) ranging from `r min(fx_szs_thrCog[fu_thrsh_CNR_ps<.05]` to `r max(fx_szs_thrCog[fu_thrsh_CNR_ps<.05]`. Also consistent was the absence of a statistically significant influence of contrast, or any contrast x protocol interactions (all ps > `r min(thrsh_CNR_ps)`). Therefore, when modeling experimental events of interest related to visual attention function, i.e. those that induce more subtle signal fluctuations than an overt response, the ME and CMRR protocols both outperform the 3D EPI. Moreover, both protocols may offer comparable CNR benefits, or at least CNR benefits that cannot be distinguished from each other in the current sample. 

#### Regions of interest
\label{sec:CNR_ROI}

```{r load_roi_act, echo=FALSE, message=F, warning=F}

# Load and tidy data HAND GLM DATA
roi_act= read.csv('../data/HANDS_tCont_quantCNR_ROI_agg.csv')
roi_act$sub <- factor(roi_act$sub)
roi_act$TR <- factor(roi_act$TR)
roi_act$roi <- factor(roi_act$roi)
roi_act$contrast <- factor(roi_act$contrast)
names(roi_act)[names(roi_act) == "tT"] = "CNR"
roi_act$contrast <- roi_act$contrast %>%  recode('LH' = 'lft_hnd',
                                                 'RH' = 'rght_hnd') 

tmp = read.csv('../data/TC_tCont_quantCNR_ROI_agg.csv')
tmp$sub <- factor(tmp$sub)
tmp$TR <- factor(tmp$TR)
tmp$roi <- factor(tmp$roi)
tmp$contrast <- factor(tmp$contrast)
names(tmp)[names(tmp) == "tT"] = "CNR"

##### checking extraction code
roi_act <- rbind(roi_act, tmp)

roi_act$TR <- roi_act$TR %>% recode('700' = 'ME',
                                    '1510' = 'CMRR',
                                    '1920' = '3D EPI')

rm(tmp)
```

```{r tst_roi_act_hnds, echo=FALSE, message=F, warning=F}

roi_act_hands <- lmer( CNR ~ TR*contrast*roi + (1|sub), data = roi_act %>% filter(contrast == "lft_hnd" | contrast == "rght_hnd"))
roi_act_hands_an <- Anova(roi_act_hands, test.statistic="F")
```

```{r hands_FU_cort, echo=FALSE, message=F, warning=F}
roi_act_hands_cort <- lmer( CNR ~ TR*contrast*roi + (1|sub), data = roi_act %>% filter(contrast == "lft_hnd" | contrast == "rght_hnd") %>% filter(roi %in% c("FEF", "LOC", "IPS")))
roi_act_hands_cort_an <- Anova(roi_act_hands_cort, test.statistic="F")
roi_act_hands_cort_mus <- emmeans(roi_act_hands_cort, ~TR|roi)
roi_act_hands_cort_cont <- contrast(roi_act_hands_cort_mus, 'tukey', adjust = 'sidak')
roi_act_hands_cort_cont <- roi_act_hands_cort_cont %>% broom::tidy()
roi_act_hands_cort_mus <- roi_act_hands_cort_mus %>% broom::tidy()
roi_act_hands_cort_ps <- roi_act_hands_cort_cont %>% select(adj.p.value) 

```


Next we sought to determine whether the pattern of results borne out for the thresholded CNR data would hold when testing CNR values from the _a priori_ defined ROIs. The mean of the top 30 % of CNR voxels was computed for each subject, ROI, protocol and contrast. A LME model showed a statistically significant influence of protocol on the CNR values from the response hand contrasts, that was modulated by the ROI factor (F(`r  roi_act_hands_an["TR:roi","Df"]`, `r roi_act_hands_an["TR:roi","Df.res"]`) = `r roi_act_hands_an["TR:roi","F"]`, p = `r roi_act_hands_an["TR:roi","Pr(>F)"]`). As above, given the known signal differences between cortical and subcortical regions, we applied the same LME model separately to the cortical and the subcortical ROIs. For the cortical ROIs, and in line with the findings above, there was a statistically significant influence of protocol on CNR values, that was modulated by ROI (F(`r  roi_act_hands_cort_an["TR:roi","Df"]`, `r roi_act_hands_cort_an["TR:roi","Df.res"]`) = `r roi_act_hands_cort_an["TR:roi","F"]`, p = `r roi_act_hands_cort_an["TR:roi","Pr(>F)"]`). For the FEF, mean CNR values for the ME protocol (mean = `r roi_act_hands_cort_mus %>% filter(roi == "FEF" & TR == "ME") %>% select(estimate)`, sd = `r roi_act_hands_cort_mus %>% filter(roi == "FEF" & TR == "ME") %>% select(std.error)*sqrt(roi_act_hands_cort_mus %>% filter(roi == "FEF" & TR == "ME") %>% select(df))`) were statistically higher relative to the 3D EPI protocol (mean = `r roi_act_hands_cort_mus %>% filter(roi == "FEF" & TR == "3D EPI") %>% select(estimate)`, sd = `r roi_act_hands_cort_mus %>% filter(roi == "FEF" & TR == "3D EPI") %>% select(std.error)*sqrt(roi_act_hands_cort_mus %>% filter(roi == "FEF" & TR == "3D EPI") %>% select(df))`, t(`r roi_act_hands_cort_cont %>% filter(roi == "FEF" & contrast == "ME - 3D EPI") %>% select(df)`) = `r roi_act_hands_cort_cont %>% filter(roi == "FEF" & contrast == "ME - 3D EPI") %>% select(estimate)`, $d$ = `r roi_act_hands_cort_cont %>% filter(roi == "FEF" & contrast == "ME - 3D EPI") %>% select(estimate) / (roi_act_hands_cort_cont %>% filter(roi == "FEF" & contrast == "ME - 3D EPI") %>% select(std.error)*sqrt(roi_act_hands_cort_cont %>% filter(roi == "FEF" & contrast == "ME - 3D EPI") %>% select(df)))`, p = `r roi_act_hands_cort_cont %>% filter(roi == "FEF" & contrast == "ME - 3D EPI") %>% select(adj.p.value)`). No other comparisons achieved statistical significance (all ps > `r min(roi_act_hands_cort_ps[roi_act_hands_cort_ps > .05])`). Therefore the ME protocol fared better than the 3D EPI sequence for the FEF, when considering activation in relation to an overt response. However, this difference was not found for the other two cortical ROIs. We return to this issue in the discussion.

```{r hands_FU_subcort, echo=FALSE, message=F, warning=F}
roi_act_hands_subcort <- lmer( CNR ~ TR*contrast*roi + (1|sub), data = roi_act %>% filter(contrast == "lft_hnd" | contrast == "rght_hnd") %>% filter(!roi %in% c("FEF", "LOC", "IPS")))
roi_act_hands_subcort_an <- Anova(roi_act_hands_subcort, test.statistic="F")
roi_act_hands_subcort_mus <- emmeans(roi_act_hands_subcort, ~TR)
roi_act_hands_subcort_cont <- contrast(roi_act_hands_subcort_mus, 'tukey', adjust = 'sidak')
roi_act_hands_subcort_cont <- roi_act_hands_subcort_cont %>% broom::tidy()
roi_act_hands_subcort_mus <- roi_act_hands_subcort_mus %>% broom::tidy()
roi_act_hands_subcort_ps <- roi_act_hands_subcort_cont %>% select(adj.p.value) 

```

```{r tst_roi_act_tgtlat, echo=FALSE, message=F, warning=F}
roi_act_TC <- lmer( CNR ~ TR*contrast + (1|sub), data = roi_act %>% filter(contrast == "LT" | contrast == "RT"))
roi_act_TC_an <- Anova(roi_act_TC, test.statistic="F")
```

```{r tst_roi_act_pspatial, echo=FALSE, message=F, warning=F}
roi_act_pspatial_T <- lmer( CNR ~ TR*contrast + (1|sub), data = roi_act %>% filter(contrast == "p8" | contrast == "p5"))
roi_act_pspatial_an <- Anova(roi_act_pspatial_T, test.statistic="F")
```

```{r tst_roi_act_lat_spat, echo=FALSE, message=F, warning=F}
roi_act_lat_pspatial_T <- lmer( CNR ~ TR*contrast + (1|sub), data = roi_act %>% filter(contrast ==  "LTp8" | contrast == "RTp8"))
roi_act_lat_pspatial_an <- Anova(roi_act_lat_pspatial_T, test.statistic="F")
```

<<<<<<< HEAD
For the subcortical ROIs, there was a statistically significant main effect of protocol (F(`r  roi_act_hands_subcort_an["TR","Df"]`, `r roi_act_hands_subcort_an["TR","Df.res"]`) = `r roi_act_hands_subcort_an["TR","F"]`, p = `r roi_act_hands_subcort_an["TR","Pr(>F)"]`), suggesting that the protocols yielded a consistent modulatory effect on CNR values across the striatal regions under study. However, follow up tests revealed that this difference is likely non-robust. Specifically, although the CNR data from the 3D EPI protocol showed a higher numerical mean (mean = `r roi_act_hands_subcort_mus %>% filter(TR == "3D EPI") %>% select(estimate)`, sd = `r roi_act_hands_subcort_mus %>% filter(TR == "3D EPI") %>% select(std.error)*sqrt(roi_act_hands_subcort_mus %>% filter(TR == "3D EPI") %>% select(df))`) relative to the ME (mean = `r roi_act_hands_subcort_mus %>% filter(TR == "ME") %>% select(estimate)`) and CMRR protocols (mean = `r roi_act_hands_subcort_mus %>% filter(TR == "CMRR") %>% select(estimate)`), none of the follow-up pairwise comparisons survived correction for multiple comparisons  (all ps > `r min(roi_act_hands_subcort_ps))`. Nor was this influence of protocol consistent across the remaining contrasts used to compute CNR values. For the remaining sets of contrasts (left or right target, p = .8 or .5 spatial cue, left target | p = .8 or right target | p = .8), none of the analyses showed a statistically significant influence of protocol on the CNR data (all ps > `r min(c(roi_act_lat_pspatial_an[,"Pr(>F)"], roi_act_TC_an[,"Pr(>F)"], roi_act_pspatial_an[,"Pr(>F)"]))`). Therefore the results suggest that although the ME sequence yields reliably higher CNR values for cortical activation, the impact of protocol is minimal in the striatal regions, rather signal is consistently low in these regions.

### Comparing CNR for Experimental Comparisons  
=======
For the subcortical ROIs, there was a statistically significant main effect of protocol (F(`r  roi_act_hands_subcort_an["TR","Df"]`, `r roi_act_hands_subcort_an["TR","Df.res"]`) = `r roi_act_hands_subcort_an["TR","F"]`, p = `r roi_act_hands_subcort_an["TR","Pr(>F)"]`), suggesting that the protocols yielded a consistent modulatory effect on CNR values across the striatal regions under study. However, although the CNR data from the 3D EPI protocol showed a higher numerical mean (mean = `r roi_act_hands_subcort_mus %>% filter(TR == "3D EPI") %>% select(estimate)`, sd = `r roi_act_hands_subcort_mus %>% filter(TR == "3D EPI") %>% select(std.error)*sqrt(roi_act_hands_subcort_mus %>% filter(TR == "3D EPI") %>% select(df))`) relative to the ME (mean = `r roi_act_hands_subcort_mus %>% filter(TR == "ME") %>% select(estimate)`) and CMRR protocols (mean = `r roi_act_hands_subcort_mus %>% filter(TR == "CMRR") %>% select(estimate)`), none of the pairwise comparisons between the three protocols survived correction for multiple comparisons  (all ps > `r min(roi_act_hands_subcort_ps)`, suggesting a non-robust influence of protocol on the CNR observed in the subcortical ROIs. For the remaining sets of contrasts (left or right target, p = .8 or .5 spatial cue, left target | p = .8 or right target | p = .8), none of the analyses showed a statistically significant influence of protocol on the CNR data (all ps > `r min(c(roi_act_lat_pspatial_an[,"Pr(>F)"], roi_act_TC_an[,"Pr(>F)"], roi_act_pspatial_an[,"Pr(>F)"]))`). Therefore the results suggest that although the ME sequence yields reliably higher CNR values for cortical activation, the impact of protocol is minimal in the striatal regions studied here.

### Comparing CNR Between Protocols for Experimental Comparisons 

\label{sec:CNR_exp_comps}

```{r loadCNRdat, echo=FALSE, message=F, warning=F}

# Load and tidy data HAND GLM DATA
CNR = read.csv('../data/HANDSs_tCNR_stat_vox_agg.csv')
CNR$sub <- factor(CNR$sub)
CNR$TR <- factor(CNR$TR)
CNR$roi <- factor(CNR$roi)
CNR$contrast <- factor(CNR$contrast)
names(CNR)[names(CNR) == "tT"] = "CNR"
CNR$contrast <- CNR$contrast %>%  recode('1' = 'left_vs_right_hand') 

tmp = read.csv('../data/TC_tCNR_stat_vox_agg.csv')
tmp$sub <- factor(tmp$sub)
tmp$TR <- factor(tmp$TR)
tmp$roi <- factor(tmp$roi)
tmp$contrast <- factor(tmp$contrast)
names(tmp)[names(tmp) == "tT"] = "CNR"

tmp$contrast <- tmp$contrast %>% recode('1' = 'tgt side',
                                        '2' = 'cert',
                                        '3' = 'cert x tgt side')

CNR <- rbind(CNR, tmp)

CNR$TR <- CNR$TR %>% recode('700' = 'ME',
                            '1510' = 'CMRR',
                            '1920' = '3D EPI')
names(CNR)[names(CNR) == "contrast"] <- "comp"
muCNR <- CNR %>% group_by(sub, TR, comp) %>%
                 summarise(mu = mean(CNR))
names(muCNR)[names(muCNR) == "comp"] = "contrast"
```


```{r thrshlook_CNR, echo=FALSE, message=F, warning=F}
#bpthrsh <- with(muCNR, boxplot(mu~contrast*TR))
```

```{r thrshLME, echo=FALSE, message=F, warning=F}

thrsh_mod <- lmer( mu ~ TR*contrast + (1|sub), data=muCNR)

thrsh_lme_an <- Anova(thrshmod, test.statistic="F")
```

```{r, thrsh_me_prot_EC_FU, echo=FALSE, message=F, warning=F}
thrsh_me_prot <- emmeans(thrshmod, "TR")
thrsh_me_cont <- contrast(thrsh_me_prot, 'tukey', adjust = 'sidak') 
thrsh_me_cont <- thrsh_me_cont %>% broom::tidy()
```  


```{r, thrsh_me_cntrst_FU, echo=TRUE, results="hide"}
thrsh_me_cont_mu <- emmeans(thrsh_mod, "contrast")
```
```{r, thrsh_me_cntrst_EC_FU, echo=FALSE, message=F, warning=F}
thrsh_me_cont_mu <- emmeans(thrshmod, "comp")


thrsh_me_cont_cont <- contrast(thrsh_me_cont_mu, 'tukey', adjust = 'sidak') 
thrsh_me_cont_cont <- thrsh_me_cont_cont %>% broom::tidy()
thrsh_me_cont_cont <- thrsh_me_cont_cont %>% filter(adj.p.value<.05)
```  

Given the minimal differences between protocols in the _a priori_ defined ROIs found when deriving CNR values from the activation contrasts, and given that the ROIs were defined on the basis of comparisons between experimental conditions, rather than on activations _per se_, we next sought to determine whether a more reliable influence of protocol could be observed for CNR values derived from comparisons between key experimental events. To this end we applied four F contrasts to the beta images resulting from the GLMs defined above, one for the comparison between response hand (left - right hand), target laterality (left target - right hand), cue probability (p = .8 - p = .5), and for the target laterality x cue probability interaction. 

#### Thresholded voxels from comparisons of experimental interest 
\label{sec:Thrsh_exp_comps}

For each F-contrast, the voxels were thresholded at p< .001, and the mean CNR value was taken for each subject, contrast and protocol. The data were then subject to an LME model with subject, contrast and protocol entered as fixed effects factors, and with a random effects intercept term for each subject. In accordance with the findings from the tSNR measures above, the ME protocol yielded statistically higher CNR relative to the 3D EPI sequence (t(`r thrsh_me_cont[thrsh_me_cont$contrast == "ME - 3D EPI", "df"]`) = `r thrsh_me_cont[thrsh_me_cont$contrast == "ME - 3D EPI", "statistic"]`, $d$ = `r thrsh_me_cont[thrsh_me_cont$contrast == "ME - 3D EPI", "estimate"] / (thrsh_me_cont[thrsh_me_cont$contrast == "ME - 3D EPI", "std.error"]*sqrt(thrsh_me_cont[thrsh_me_cont$contrast == "ME - 3D EPI", "df"]+1))`, p = `r thrsh_me_cont[thrsh_me_cont$contrast == "ME - 3D EPI", "adj.p.value"]`). However, unlike the findings pertaining to tSNR, none of the other comparisons achieved statistical siginifance (`r min(thrsh_me_cont$adj.p.value[thrsh_me_cont$adj.p.value > .05])`). As would be anticipated, the response hand contrast yielded higher CNR values than the remaining contrasts (all ps < .0001, $d$ range = [`r thrsh_me_cont_cont[1,"estimate"] / (thrsh_me_cont_cont[1,"std.error"]*sqrt(thrsh_me_cont_cont[1,"df"]+1))`, `r thrsh_me_cont_cont[3,"estimate"] / (thrsh_me_cont_cont[3,"std.error"]*sqrt(thrsh_me_cont_cont[3,"df"]+1))`]. Therefore, CNR data from the comparisons between experimental events also show that the ME protocol fares better than the 3D EPI sequence, however the advantage relative to the CMRR protocol is not observed in this CNR data.

```{r thrshCNR, out.width="70%", fig.cap="CNR from voxels thresholded at p< .001 for each contrast. A) CNR values from the response hand contrast for one representative subject and session. B) Densities of CNR scores. Overall, the ME protocol showed higher mean CNR scores than the 3D EPI sequence. C) Showing the target laterality x cue probability contrast for the same subject and session as panel A.  ME = multi-echo, CMRR =, 3D = 3D Echo Planar Imaging, CNR = contrast noise ratio."}

thrsh_CNR_fig_pth <- '../images/thrsh_CNR.pdf' 
include_graphics(thrsh_CNR_fig_pth)
```

#### CNR from comparisons of experimental interest in each ROI

Next we sought to determine whether the advantage of the ME sequence remained evident when the CNR data from the comparisons of interest were taken from the _a priori_ defined ROIs. We extracted CNR values for each subject, contrast and ROI, and computed an average score on the top 30 % of values for each. Visual inspection of the data showed that one of the participants scored greater than 3 standard deviations from the group mean on all measures. Therefore their data is excluded from the subsequent analysis. 

```{r loadROICNRdat, echo=FALSE, message=F, warning=F}

# Load and tidy data
roi_cnr = read.csv('../data/TC_tCNR_ROI_agg.csv')
roi_cnr$sub <- factor(roi_cnr$sub)
roi_cnr$TR <- factor(roi_cnr$TR)
roi_cnr$roi <- factor(roi_cnr$roi)
roi_cnr$contrast <- factor(roi_cnr$contrast)
names(roi_cnr)[names(roi_cnr) == "tT"] = "CNR"
roi_cnr$contrast <- roi_cnr$contrast %>% recode('1' = 'tgt side',
                                        '2' = 'cert',
                                        '3' = 'cert x tgt side')
roi_cnr$TR <- roi_cnr$TR %>% recode('700' = 'ME',
                                    '1510' = 'CMRR',
                                    '1920' = '3D')
roi_cnr <- roi_cnr %>% mutate(roi=factor(roi, levels = c('FEF', 'IPS', 'LOC', 'VS', 'CN', 'Put', 'GPe', 'GPi', 'STN')))

tmp <- read.csv('../data/HANDS_tCNR_ROI_agg.csv')
names(tmp)[names(tmp) == "tT"] = "CNR"
tmp$contrast <- "resp hand"
tmp$TR <- factor(tmp$TR)
tmp$TR <- tmp$TR %>% recode('700' = 'ME',
                            '1510' = 'CMRR',
                            '1920' = '3D')
roi_cnr <- rbind(roi_cnr, tmp)

```


```{r, boxplot, echo=FALSE, message=F, warning=F}

#with(roi_cnr, boxplot(CNR~contrast*roi*TR))
#with(roi_cnr %>% filter(sub != "1"), boxplot(CNR~contrast*roi*TR)) # sub 1 = outlier, remove
roi_cnr <-roi_cnr %>% filter(sub != "1")
```

```{r, stats_bl_conts, echo=FALSE, message=F, warning=F}

# this code shows the main effect of TR, and then shows the followup comparisions
roi_SNR_mod <- lmer( CNR ~ TR*roi*contrast + (1|sub), data=roi_cnr )
roi_SNR_mod_an <- Anova(roi_SNR_mod, test.statistic="F")

```

```{r, tSNR_TR_roi_int, echo=FALSE, message=F, warning=F}
roi_tsnr_mus <- emmeans(roi_SNR_mod, ~TR | roi)
roi_tsnr_cont <- contrast(roi_tsnr_mus, 'tukey', adjust = 'sidak')
roi_tsnr_cont <- roi_tsnr_cont  %>% broom::tidy()
#roi_tsnr_cont %>% filter(adj.p.value < .05)
```

Comparable to the tSNR data, the extent to which CNR values differed between protocols was modulated by the ROI factor, as evidenced by a protocol x ROI interaction (F(`r roi_SNR_mod_an["TR:roi","Df"]`, `r roi_SNR_mod_an["TR:roi","Df.res"]`) = `r roi_SNR_mod_an["TR:roi","F"]`, p = `r roi_SNR_mod_an["TR:roi","Pr(>F)"]`). Of the cortical ROIs, the IPS region showed a pattern of CNR values that exactly matched the tSNR findings, where the ME protocol yielded higher CNR values relative to both the CMRR protocol (t(`r roi_tsnr_cont[roi_tsnr_cont$roi == "IPS" & roi_tsnr_cont$contrast == "ME - CMRR", "df"]`) = `r roi_tsnr_cont[roi_tsnr_cont$roi == "IPS" & roi_tsnr_cont$contrast == "ME - CMRR", "statistic"]`, $d$ = `r roi_tsnr_cont[roi_tsnr_cont$roi == "IPS" & roi_tsnr_cont$contrast == "ME - CMRR", "estimate"]/(roi_tsnr_cont[roi_tsnr_cont$roi == "IPS" & roi_tsnr_cont$contrast == "ME - CMRR", "std.error"] * sqrt(roi_tsnr_cont[roi_tsnr_cont$roi == "IPS" & roi_tsnr_cont$contrast == "ME - CMRR", "df"]+1))`, p = `r roi_tsnr_cont[roi_tsnr_cont$roi == "IPS" & roi_tsnr_cont$contrast == "ME - CMRR", "adj.p.value"]`), and to the 3D-EPI protocol (t(`r roi_tsnr_cont[roi_tsnr_cont$roi == "IPS" & roi_tsnr_cont$contrast == "ME - 3D", "df"]`) = `r roi_tsnr_cont[roi_tsnr_cont$roi == "IPS" & roi_tsnr_cont$contrast == "ME - 3D", "statistic"]`, $d$ = `r roi_tsnr_cont[roi_tsnr_cont$roi == "IPS" & roi_tsnr_cont$contrast == "ME - 3D", "estimate"]/(roi_tsnr_cont[roi_tsnr_cont$roi == "IPS" & roi_tsnr_cont$contrast == "ME - 3D", "std.error"] * sqrt(roi_tsnr_cont[roi_tsnr_cont$roi == "IPS" & roi_tsnr_cont$contrast == "ME - 3D", "df"]+1))`, p = `r roi_tsnr_cont[roi_tsnr_cont$roi == "IPS" & roi_tsnr_cont$contrast == "ME - 3D", "adj.p.value"]`), albeit with a small effect size (see Figure \@ref(fig:cortCNR), panels A and B). CNR values from the LOC ROI were also statistically higher for the ME relative to the 3D EPI sequence (t(`r roi_tsnr_cont[roi_tsnr_cont$roi == "LOC" & roi_tsnr_cont$contrast == "ME - 3D", "df"]`) = `r roi_tsnr_cont[roi_tsnr_cont$roi == "LOC" & roi_tsnr_cont$contrast == "ME - 3D", "statistic"]`, $d$ = `r roi_tsnr_cont[roi_tsnr_cont$roi == "LOC" & roi_tsnr_cont$contrast == "ME - 3D", "estimate"]/(roi_tsnr_cont[roi_tsnr_cont$roi == "LOC" & roi_tsnr_cont$contrast == "ME - 3D", "std.error"] * sqrt(roi_tsnr_cont[roi_tsnr_cont$roi == "LOC" & roi_tsnr_cont$contrast == "ME - 3D", "df"]+1))`, p = `r roi_tsnr_cont[roi_tsnr_cont$roi == "LOC" & roi_tsnr_cont$contrast == "ME - 3D", "adj.p.value"]`). Additionally in the LOC, and in line with the findings in the FEF for the activation contrasts, CNR was also higher for the CMRR relative to the 3D EPI sequence (t(`r roi_tsnr_cont[roi_tsnr_cont$roi == "LOC" & roi_tsnr_cont$contrast == "CMRR - 3D", "df"]`) = `r roi_tsnr_cont[roi_tsnr_cont$roi == "LOC" & roi_tsnr_cont$contrast == "CMRR - 3D", "statistic"]`, $d$ = `r roi_tsnr_cont[roi_tsnr_cont$roi == "LOC" & roi_tsnr_cont$contrast == "CMRR - 3D", "estimate"]/(roi_tsnr_cont[roi_tsnr_cont$roi == "LOC" & roi_tsnr_cont$contrast == "CMRR - 3D", "std.error"] * sqrt(roi_tsnr_cont[roi_tsnr_cont$roi == "LOC" & roi_tsnr_cont$contrast == "CMRR - 3D", "df"]+1))`, p = `r roi_tsnr_cont[roi_tsnr_cont$roi == "LOC" & roi_tsnr_cont$contrast == "CMRR - 3D", "adj.p.value"]`, see Figure \@ref(fig:cortCNR), panel C). All remaining comparisions did not achieve statistical significance. [Thus the ME protocol fares best across multiple measurements of signal quality for cortical ROIs, with the CMRR outperforming the 3D EPI sequence less consistently.]

```{r, cortCNR, out.width="60%", fig.cap="CNR data from cortical regions of interest. A) CNR values for the target laterality x cue probability contrast from each protocol (columns) for two representative subjects (rows) with the IPS region outlined in blue. B) Average CNR scores by subject for each protocol (x-axis) and cortical region (panels). The ME protocol showed higher mean CNR scores than the CMRR protocol. C) Same as panel A, but with the LOC region outlined in blue. P = protocol, ME = multi-echo, CMRR =, 3D EPI = 3D Echo Planar Imaging, CNR = contrast noise ratio, IPS = intraparietal sulcus, FEF = frontal eye fields, LOC = lateral occipital complex, sub = subjects."}

cort_CNR_fig_pth <- '../images/CNR_cortical_story.png' 
include_graphics(cort_CNR_fig_pth)

```

We next tested whether the same pattern of findings would hold for the subcortical ROIs. In contrast to what was observed for FEF, LOC and IPS, no statistical differences between protocols were detected for the subcortical ROIs (all ps > `r min(roi_tsnr_cont$adj.p.value[roi_tsnr_cont$adj.p.value > .05])`). The CNR images are presented in Figure \@ref{fig:subcortCNR}. Minimal CNR values were observed across subcortical ROIs (see Figure \@ref{fig:subcortCNR} panels A & B for CNR data from the response hand and target laterality x cue probability contrasts respectively, and panel C for the mean CNR values for two example subcortical ROIs). Visual inspection of the parameters recovered by the FIR model showed a typical HRF shape for the subcortical ROIs (panel D), which was much lower in amplitude relative to the parameters recovered from the cortical ROIs. Thus, the findings with regard to subcortical ROIs mirror those as described above. Specifically, although the ME sequence fares better for cortical ROIs, we do not observe an advantage for any of the protocols at the subcortical level, even for contrasts that involve an overt response.

```{r, subcortCNR, out.width="70%", fig.cap="CNR data from subcortical regions of interest. A) CNR values from a representative subject for the response hand contrast from each protocol (columns) for the CN and Put (rows, outlined). B) CNR values from the target laterality x cue probability contrast with the same configuration as panel A. C) Mean CNR values for each protocol (x-axis) for the CN and Put (panels). Each line reflects one subject. D) Parameters recovered by the FIR function for the IPS, CN and Put."}

subcort_CNR_fig_pth <- '../images/CNR_subcortical_story.png' 
include_graphics(subcort_CNR_fig_pth)
```

# Discussion

Given the recent strong theoretical interest in the contribution of the basal ganglia to spatial visual attention function, we sought to compare SNR between protocols at 7T when imaging basal ganglia activity during a visual selection task. We compared a multi-echo, multi-band sequence (ME), a single-echo multiband sequence (CMRR) and a 3D EPI sequence. Importantly, we constrained the field-of-view (FOV) across sequences, so that each was well suited to concurrently capturing activity from the known cortical visual-selection network (FEF, IPS, LOC) and from the theoretically relevant nuclei of the basal ganglia. Participants completed a visual selection paradigm where probabilistic cues signalled the likely location of upcoming targets. The task was performed over 3 sessions, using 1 run from each protocol at each session. SNR was assessed using two methods; temporal signal-to-noise ratio (tSNR) and contrast-noise-ratio (CNR). CNR was assessed for each protocol for voxels i) that showed a strong response to the experimental events or comparisons of interest, ii) from the cortical nodes of interest and iii) from the nuceli of the basal ganglia. tSNR measures indicated that the ME protocol outperformed the 3D EPI protocol, which in turn outperformed the CMRR protocol, for both cortical and subcortical ROIs. CNR measures instead showed that the ME protocol outperformed the other two protocols only when experimental events included an overt action. In contrast, both the ME and CMRR protocols fared better than the 3D EPI protocol when experimental events and comparisons involved more subtle manipulations, such as a response to a spatial visual cue. Moreover, the ME and CMRR protocols could not be distinguished from one another under these latter conditions. Although this was the case for the cortical nodes of interest, signal in the basal ganglia nuclei were consistently low, and protocol had minimal influence on signal in these regions. Therefore, although the ME protocol clearly offered signal advantages across SNR tests, comparable signal performance may be gained from a similar single-echo protocol (CMRR) when assessing signal changes in the visual attention system.

Therefore, our data show that SE or ME multi-band protocols fare as well as each other for SNR when the goal is to model activity in response to visual events of interest. Militec et al [-@mileticFMRIProtocolOptimization2020] drew comparable conclusions when examining SNR in the basal ganglia during completion of a task that involves the execution or witholding of overt actions. Given that most pre-processing and analysis pipelines are built to more readily handle SE data, then it makes practical sense to use an optimised SE protocol when seeking to gain whole brain coverage at 7T. It is interesting that this was not observed in our data when modeling activity in response to overt action. In this case, our findings align more closely with those of Puckett et al [-@puckettUsingMultiechoSimultaneous2018], who found an advantage for ME over SE protocols across tSNR and CNR measurements. These authors used a block design comparing complex and simple overt movement sequences, which should have ensured maximal fluctuations in BOLD activity, given the robust manipulation. One possibility is that the advantages of ME is evident under conditions that induce strong activation changes, such as during the execution of overt actions. It may therefore be that when induced signal changes are more subtle, such as event-related manipulations in the psychological response to well-matched visual stimuli, there may be an upper bound for what can be gained for SNR when retaining a whole-brain FOV, which is reached by both ME and SE multi-band protocols. It would be of interest to see if these conclusions generalise when imaging activity in response to multiple cognitive phenomena. 

Interestingly, although the SNR advantages were clear when imaging cortical activity, we observed consistently low SNR in the basal ganglia despite modeling overt actions, and despite the converging evidence and theory suggesting that activity in basal ganglia nuclei should be modulated in correspondence to shifts in covert visual selection [@arcizetCovertSpatialSelection2018; @amitaOptogeneticManipulationValuecoding2020a; yamamotoWhatWhereInformation2012; @espositoSubcorticalNetworkImplicit2021]. There was some suggestion in the current data that CNR for activation changes may be better for 3D EPI sequences when imaging the basal ganglia. However, given that overall CNR levels were well below what would be expected for voxels that would be deemed as statictially significant, and given that this finding was not replicated for remaining CNR-based comparisons, it is likely that this finding could be spurious. These findings may be due to the fact that motoric events in our current design were very brief. Specifically, we used an event-related design, responses (button presses) were spaced out by multiple seconds, and were rapid in execution. We had assumed that the randomised order of response hand (across trials) would amount to an appropriately efficient experimental design [@henson2007efficient]. However, it may be that adding a randomised interval between motoric events [@mileticFMRIProtocolOptimization2020], or selectively increasing the duration of action-related processes [@mileticFMRIProtocolOptimization2020; @puckettUsingMultiechoSimultaneous2018], or employing a block design [@puckettUsingMultiechoSimultaneous2018], may have resulted in better efficiency to image basal ganglia activity in the current study. Alternatively, previous work has shown increases in putamen activity when trial by trial violations of visual-spatial expectations are encoded as a regressor to the first-level GLM [vosselCorticalCouplingReflects2015]. Therefore, combining the anatomical ROI approach as we have used here, in conjunction with an experimental scheme that incorporates quantification of trial-by-trial belief updates may more succesfully elicit more robust changes in basal ganglia activity that are related to visual-selection function.

The findings pertaining to SNR observed in the cortex was broadly consistent across CNR measures (based on activation or comparison). The ME protocol always out performed the 3D EPI protocol, and so too did the CMRR when CNR measures were based on experimental comparisons. However, when activation based CNR measures were used, protocol differences were only observed for FEF, whereas when CNR measures were based on comparison contrasts (e.g. left target - right target), then protocol differences were observed only for IPS and LOC. Visual inspection of figure \@ref{fig:cortCNR} shows that in the case of IPS and LOC, the _a priori_ defined ROI neighboured the regions of strongest signal change. These results suggest that the conditions under which previous work elucidated ROIs should be taken into account when defining the contrasts that will be used to measure SNR within a given region of interest; i.e. a comparison contrast may yield more stable SNR measures for some regions such as the LOC or IPS. Moreover, the current findings, in tandem with those that show that activity peaks in the networks that underpin cognitive effort may be subject to large individual differences [@crittendenTaskDifficultyManipulation2014], suggest that defining cortical ROIs solely from meta-analyses of functional localisation may not be the most optimal approach when seeking to understand how CNR varies within a given ROI. Indeed, the meta-analysis used in the current study would have been largely based on data collected from 3T, and recent findings suggest that functional localisation can differ when the same task is used at both 3T and 7T [@torrisiStatisticalPowerComparisons2018]. Therefore a method that combines both functional and anatomical information to identify cortical areas of interest, such as using the intersection of a functional meta-analysis and a standard parcellation of the cortex, could potentially yield more stable CNR estimates across contrasts.

We also observed differences between protocol comparisons when tSNR measures were used, relative to CNR measures. Specifically, both the ME and 3D EPI protocols outperformed the CMRR protocol for the tSNR measure, whereas both the ME and CMRR protocol outperformed the 3D EPI protocol when we used the CNR measures. This shows that tSNR measures are insensitive to the relative contributions of baseline and activation signal strength, yet the latter is critically important for task-related fMRI. We noticed during preprocessing that the 3D EPI sequence suffered from distortion to a greater extent than was observed for the other two sequences, which likely contributed to its poorer performance with the CNR measures. Regardless, it is clear from the current findings that protocol optimisation judgements should not be made on tSNR measures alone, at least in the context of task-related fMRI.

The primary goal of the current work was to optimise imaging protocols at 7T for the basal ganglia and the cortical nodes of the visual-selection network. Therefore the primary consideration when selecting protocols was to minimise TE time while maintaining a sufficient field of view to capture all the ROIs. These contraints meant that our protocols were required to vary along various other dimensions such as TR, voxel size and multiband factor. We therefore do not lay claim as to the causal factor that resulted in comparable SNR benefits for the ME and CMRR protocols. Instead, we provide this data as a guideline for other researchers wishing to use 7T to image brain activity during visual-selection, or during other psychological phenomena of interest. Broadly, although ME protocols offer stronger SNR more consistently than other protocols, it appears that both multiband protocols (ME or SE) offer comparable SNR performance when making experimental comparisons between cognitive events at the whole-brain level. 

*Conclusions*


# Acknowledgements

We thank Nicole Atcheson, Sarah Daniel and Aiman Al-Najjar for their essential support in 7T data collection. We also thank Aswin Narayanan and the UQ RDM team for organising and supplying the infrastructure that greatly facilitated data governance for this project. We also thank Johan van der Meer and Remi Gau for their discussions on the relative merits of various preprocessing choices, and Remi particularly for the enthusiastic discussions on the benefits of carpet plots. We also thank Paul Dux for his helpful comments on an initial draft of this manuscript.

\clearpage

# References